<img src="https://habrastorage.org/webt/4s/ux/s6/4suxs6qsnj396fhwpv6ht0w1twk.png" />
(картинку править - увеличительное стекло найти поприличнее, поставить знак вопроса)

TLDR Описан небольшой скрипт для Octave/MATLAB, позволяющий оценить ошибки расчёта углов ориентации по измерениям МЭМС акселерометров и магнитометров. На входе скрипта - параметры датчиков из даташита (и/или погрешности калибровки). Статья может быть полезна тем, кто начинает использовать инерциальные датчики в своих устройствах. Небольшой ликбез по датчикам и модели их погрешностей прилагается.

cut

При разработке устройств, в которых необходимо оценивать углы ориентации, может встать вопрос, какой МЭМС датчик выбрать. Производители датчиков приводят множество параметров, из которых нам требуется получить полезную информацию о качестве датчика.

Чтобы разобраться, на какие точности оценки углов мы можем рассчитывать, нужно приложить некоторое количество усилий. Вот как мы решили эту задачу.

Примем такие условия:
- мы хотим оценить углы ориентации неподвижного устройства (почему - спойлер, под ним - потому что ориентацию подвижного устройства просто по формулам не посчитать, и нужно использовать более хитрые алгоритмы)
- для оценки углов мы будем использовать измерения МЭМС акселерометров и магнитометров

Но сначала небольшая вводная часть.
 
На хабре есть достаточно статей, в которых хорошо описаны различные виды представления ориентации. Чтобы не писать одно и то же, лучше посмотреть, например, <a href="https://habr.com/ru/post/438060/"> здесь</a>.

<h3>Углы ориентации</h3>
<img src="https://habrastorage.org/webt/um/c0/g2/umc0g2rtovmztp_ylk0ngjmj5aq.png" />
(картинку править - должна соответствовать описанию ниже)

Будем понимать под углами ориентации объекта углы Эйлера roll, pitch, yaw, связывающие системы координат RPY (собственную систему координат объекта, с ним связанную) и локальную систему координат ENU (восток-север-верх). Углы roll, pitch, yaw обозначают поворот, который нужно совершить осям RPY чтобы перейти в оси ENU. Соответственно, нулевые углы roll, pitch, yaw означают, что ось R объекта смотрит на восток, ось P объекта смотрит на север, ось Y - вверх. Порядок поворота - начиная с последнего угла: сначала на yaw, потом на pitch, потом на roll.
(это описание надо проверить в скрипте)

<h3>Акселерометр</h3>
Это датчик, измеряющий проекцию кажущегося ускорения на оси чувствительности. Кажущегося - потому что измеряет и силу тяжести тоже, в то время как акселерометр неподвижен. Проще всего представить этот прибор как грузик на пружинках, а выдаваемые измерения - степень растягивания пружины. Если акселерометр покоится - пружина растянута лишь силой тяжести. Если ускоряется - то будет сумма сил - инерции грузика и действия силы тяжести.

Примем следующую модель измерений для этого датчика:
$$display$$a_{rpy}=\left ( I+m_{a} \right )\cdot A_{rpy}+b_{a}+n_{a},$$display$$ 
где $inline$a_{rpy}$inline$ – измеряемое ускорение в ССК (собственной системе координат) RPY, $inline$I$inline$ – единичная матрица, $inline$m_{a}$inline$ – матрица перекосов осей и масштабных коэффициентов акселерометра, $inline$A_{rpy}$inline$ – вектор истинного ускорения в ССК RPY, $inline$b_{a}$inline$ – вектор смещения нулей акселерометра, $inline$n_{a}$inline$ – шум измерений.

<h3>Магнитометр</h3>
Это датчик, который  измеряет проекцию магнитного поля на оси чувствительности. Магнитометру свойственны искажения hard-iron и soft-iron: первое заключается в действии на измеряемое магнитометром поле постоянного магнита, имеющего собственное магнитное поле. Этот эффект является аддитивным, то есть к измеряемому полю добавляется постоянная составляющая. Искажения soft-iron определяются наличием посторонних предметов, не имеющих собственного магнитного поля, но искажающих поле, измеряемое магнитометром. Этот тип искажений имеет мультипликативный эффект.

Используемая модель измерений магнитометра:
$$display$$m_{rpy}=S_{m}\cdot M_{rpy}+b_{m}+n_{m},$$display$$ 
где $inline$m_{rpy}$inline$ – измерения магнитометра в ССК RPY, $inline$S_{m}$inline$ – диагональная матрица перекосов осей, которая включает в себя эффект soft–iron, $inline$M_{rpy}$inline$ – вектор истинной магнитной индукции в ССК, $inline$b_{m}$inline$ – смещение нулей магнитометра и эффект hard–iron, $inline$n_{m}$inline$ – шум измерений.

<h3>Расчет углов ориентации</h3>
Возьмем самый простой способ расчета углов, приведенный, например, в [ссылка]

$$display$$R=\arctan \left ( \frac{a_{p}}{a_{y}} \right ),$$display$$
$$display$$P=\arctan\left ( \frac{-a_{r}}{\sqrt{a_{p}^{2}+a_{y}^{2}}} \right ),$$display$$
$$display$$Y=\arctan 2\left ( \frac{M_{p}}{M_{r}} \right ),$$display$$
где $inline$arctan 2$inline$ - функция полного арктангенса.

где $inline$A_{rpy}$inline$ ...

<h3>Ошибки оценивания углов ориентации</h3>
<h3>Описание алгоритма</h3>
<img src="http://habrastorage.org/webt/mr/1a/st/mr1astvnpi2hg1takl2oya6hnwu.png" alt="image"/>
1. Сформируем массивы случайных углов Эйлера roll, pitch, yaw. Они будут задавать "истинную" ориентацию объекта в модели. (спойлер Зачем много углов - потому что ошибки зависят от значения углов ориентации, и если мы хотим получить представление об их величине во всем диапазоне изменения - то это самый простой способ).

Еще необходимо сформировать вектор истинных магнитных плотностей по трём осям в локальной системе координат (ЛСК). И задать вектор силы тяжести.

2. Заполняем модели погрешностей датчиков. Из datasheet для выбранных датчиков взяты необходимые параметры:
<table>
  <tr>
    <th>ИИБ</th>
    <th>MPU9250 Акселерометр</th>
     <th>MPU9250 Магнитометр</th>
<th>ADIS16448 Акселерометр</th>
<th>ADIS16448 Магнитометр</th>
  </tr>
  <tr>
    <td>Смещение нулей</td>
    <td>$$display$$\pm 60(x,y), 
$$display$$ $$display$$\pm 80(z) mg $$display$$ </td>
    <td>$$display$$1 \ мкТл (после\ калибровки)$$display$$</td>
<td>ячейка 41</td>
<td>Ячейка 51</td>
  </tr>
  <tr> 
    <td>Погрешность масштабного коэффициента</td>
    <td>$$display$$\pm3\% $$display$$</td>
    <td>$$display$$10\%(после\ калибровки)$$display$$</td>
<td>Ячейка 42</td>
<td>Ячейка 52</td>
  </tr>
<tr> 
    <td>Перекосы осей</td>
    <td>$$display$$\pm2\%$$display$$</td>
    <td>$$display$$ – $$display$$</td>
<td>Ячейка 43</td>
<td>Ячейка 53</td>
  </tr>
<tr> 
    <td>Шум на выходе</td>
    <td>$inline$ 0.3 mg/sqrt(Гц)\rightarrow 4.4 mg\:СКО (218 Гц)$inline$</td>
    <td>$inline$ 0.6 mg\: мкТл\:СКО $inline$</td>
<td>Ячейка 44</td>
<td>Ячейка 54</td>
  </tr>
</table>

написать как таблица заполняет формулы модели погрешностей

3) Из случайных углов R, P, Y формируется матрица преобразования из собственной системы координат (ССК) в локальную (ЛСК). За ЛСК принята СК «восток–север–верх» (ENU):
$$display$$C_{ned}^{rpy}=\begin{vmatrix}
cy\cdot cp &-cr\cdot sy+sr\cdot cy\cdot sp &sr\cdot sy+cr\cdot cy\cdot sp \\ 
sy\cdot cp &cr\cdot cy+sr\cdot sy\cdot sp & -sr\cdot cy+cr\cdot sy\cdot sp \\ 
-sp &sr\cdot cp &cr\cdot cp 
\end{vmatrix},$$display$$
где $inline$cr=\cos R$inline$, $inline$sr=\sin R$inline$, $inline$cp=\cos P$inline$, $inline$sp=\sin P$inline$, $inline$cy=\cos P$inline$, $inline$sy=\sin Y$inline$.
Используя данную матрицу можно получить выражения для истинных ускорений и магнитных плотностей в ССК:
$$display$$A_{rpy}=\left ( C_{ned}^{rpy} \right )^{T}\cdot \begin{vmatrix}
0\\ 
0\\
1\\
\end{vmatrix},$$display$$
$inline$\begin{vmatrix}
0\\ 
0\\ 
1\\
\end{vmatrix}$inline$ - вектор, определяющий направление гравитационного ускорения, выраженный в единицах g.
$$display$$M_{rpy}=\left ( C_{ned}^{rpy} \right )^{T}\cdot M_{ned},$$display$$
$inline$ M_{ned}$inline$ - сформированный вектор истинных магнитных плотностей. 
Далее эти выражения используются в модели измерения датчиков.

4)  По измерениям датчиков рассчитываются новые углы по формулам:
$$display$$R=\arctan \left ( \frac{a_{p}}{a_{y}} \right ),$$display$$
$$display$$P=\arctan\left ( \frac{-a_{r}}{\sqrt{a_{p}^{2}+a_{y}^{2}}} \right ),$$display$$
$$display$$Y=\arctan 2\left ( \frac{M_{p}}{M_{r}} \right ),$$display$$
где $inline$arctan 2$inline$ - функция полного арктангенса.

5) Ошибки измерения углов ориентации по используемым моделям измерений датчиков рассчитываются как разность между истинными углами R, P, Y и углами, рассчитанными по измерениям датчиков.

<h3>Результаты</h3>
Вот что получается для наших двух датчиков, взятых для примера.
(тут картинки ошибок углов roll pitch yaw в зависимости от них же)
<img src="https://habrastorage.org/webt/mg/6o/eb/mg6oebpyq4pvqcwxwrymdvjab_y.jpeg" />
(график слишком крупно выглядит)

(спойлер - Почему на границах ошибки больше? - объяснение про то, что такая математика)

(спойлер - можем поиграться с входными параметрами и понять, чем определяются ошибки)
<b>Влияние погрешностей акселерометра на ошибки оценивания углов крена и тангажа</b>
<b>Влияние погрешностей магнитометра на ошибки оценивания магнитного азимута</b> 
<b>Влияние погрешностей акселерометра и магнитометра на ошибки оценивания магнитного азимута</b>

<h3>Выводы</h3>
<ul>
<li> Разработана модель, позволяющая оценивать погрешности расчёта углов ориентации по измерениям акселерометров и магнитометров с учётом их погрешностей.</li>
<li> Из представленных зависимостей ошибок оценивания углов ориентации можно сделать вывод о том, что эти ошибки являются функциями зависимостей от одновременно всех углов ориентации. При этом максимальные значения ошибок наблюдаются на границах выбранных диапазонов измерения углов. </li>
<li> Акселерометры вносят значительные ошибки в оценивание магнитного азимута.</li>
<li>Получены оценки погрешностей углов крена, тангажа, магнитного азимута для ИИБ:
Для MPU9250 ошибка крена до 45.6̊ , тангажа до 8.3̊, магнитного азимута до 35̊.</li>
</ul>

(Спойлер - Дисклеймер: 
 - не рекламируем и не рекомендуем покупать эти датчики (они уже довольно старые), 
 - не учитываем влияние вибрации, влияние нелинейности измерений, нестабильности - это первое приближение к ошибкам).

<h3>литература</h3>