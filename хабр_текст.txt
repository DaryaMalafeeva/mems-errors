<img src="https://habrastorage.org/webt/ku/3s/cx/ku3scxjdjpln8q8migqrpdy1ct8.png" />
При разработке устройств, в которых необходимо оценивать углы ориентации, может встать вопрос - какой МЭМС датчик выбрать. Производители датчиков приводят множество параметров, из которых нам требуется получить полезную информацию о качестве датчика.
Чтобы понять, на какие точности углов мы можем рассчитывать, нужно приложить некоторое количество усилий.  
TLDR: Описан небольшой скрипт для Octave/MATLAB, позволяющий оценить ошибки расчёта углов ориентации по измерениям МЭМС акселерометров и магнитометров. На входе скрипта - параметры датчиков из даташитов (и/или погрешности калибровки). Статья может быть полезна тем, кто начинает использовать инерциальные датчики в своих устройствах. Небольшой ликбез по датчикам прилагается. <a href="https://github.com/DaryaMalafeeva/mems-errors">Ссылка на гитхаб</a> тоже.
<habracut text="Вот как мы решили эту задачу:"/>

Сходу примем такие условия:
<ul>
	<li>Мы хотим оценить углы ориентации неподвижного устройства. <spoiler title="Почему?">
Ориентацию подвижного устройства просто по формулам не посчитать, нужно использовать хитрые алгоритмы.
</spoiler></li>
	<li>Для оценки углов мы будем использовать измерения МЭМС акселерометров и магнитометров.</li>
</ul>
<i>Краткий ликбез</i>
<h2>Углы ориентации</h2>
<img src="https://habrastorage.org/webt/1l/fw/ci/1lfwcikfiyuqmzdrtn-lo23rxrk.png" />
Будем понимать под углами ориентации объекта углы Эйлера - крен (roll), тангаж (pitch), рыскание (yaw), связывающие собственную систему координат XYZ объекта и локальную систему координат восток-север-верх (ENU - East North Up). Углы roll, pitch, yaw обозначают поворот, который нужно совершить осям XYZ чтобы перейти в оси ENU. Соответственно, нулевые углы означают, что ось X объекта смотрит на восток, ось Y объекта смотрит на север, ось Z - вверх. Порядок поворота осей - начиная с последнего угла: сначала на yaw (вокруг оси Z), потом на pitch (вокруг оси Y), потом на roll (вокруг оси X).

<h2>Акселерометр</h2>Это датчик, измеряющий проекцию кажущегося ускорения на ось чувствительности. Кажущегося - потому что измеряет и силу тяжести тоже, даже в то время как акселерометр неподвижен. Проще всего представить акселерометр как грузик на пружинке, его  выдаваемые измерения  пропорциональны степени растяжения пружины. Если акселерометр покоится - пружина растянута лишь силой тяжести. Если ускоряется - то будет сумма сил: инерции грузика $inline$(m\cdot a)$inline$ и силы тяжести.
Примем следующую модель измерений триады ортогональных (взаимно перпендикулярных) акселерометров:
$$display$$a_{XYZ}=\left ( I+m_{a} \right )\cdot A_{XYZ}+b_{a}+n_{a},$$display$$ где $inline$a_{XYZ}$inline$ – измеряемое ускорение в ССК (собственной системе координат) XYZ, $inline$I$inline$ – единичная матрица (в нашем случае размерности $inline$3 \times 3$inline$), $inline$m_{a}$inline$ – матрица перекосов осей и масштабных коэффициентов акселерометра, $inline$A_{XYZ}$inline$ – вектор истинного ускорения в ССК XYZ, $inline$b_{a}$inline$ – вектор смещения нулей акселерометра, $inline$n_{a}$inline$ – шум измерений.

Когда дело доходит до разбора параметров  даташита к определённому датчику возникает проблема - производители именуют одни и те же параметры по-разному. Вторая проблема - единицы измерения и как их преобразовать к удобному для расчётов виду. Чтобы вы страдали чуть меньше тут приведена небольшая инструкция.
<spoiler title="Как выбираются параметры акселерометра из даташита ">
<h3>Для MPU-9250:</h3>
<ul>
	<li>Смещение нулей - Zero-G Initial Calibration Tolerance - выражается в даташите как mg, то есть для расчётов надо домножить на $inline$10^{-3}$inline$.</li>
        <li>Погрешность масштабных коэффициентов - Initial Tolerance - выражается в процентах, для расчётов надо домножить на $inline$10^{-2}$inline$.</li>
        <li>Перекосы осей - Cross Axis Sensitivity - также выражены в процентах. </li>
        <li> </li>
        <li> </li>
</ul>
<h3>Для ADIS16488A:</h3>
<ul>
       <li>r </li>
       <li> </li>
       <li> </li>
       <li> </li>
</ul>
</spoiler>
<h2>Магнитометр</h2>Датчик, который измеряет проекцию индукции магнитного поля на ось чувствительности. Магнитометру свойственны искажения hard-iron и soft-iron. Hard-iron искажение - это аддитивный эффект, когда к измеряемому полю добавляется постоянная составляющая. Причиной может быть, например, действие постоянного магнита или собственное смещение нуля датчика. Искажение soft-iron - мультипликативный эффект, отражающий изменение направления и/или ослабление вектора магнитной индукции. Этот эффект может быть вызван наличием металлического предмета в непосредственной близости от магнитометра или же собственными искажениями датчика - погрешностью масштабного коэффициента или перекосом его оси чувствительности.
Примем модель измерений триады магнитометров:
$$display$$m_{XYZ}=S_{m}\cdot M_{XYZ}+b_{m}+n_{m},$$display$$ где $inline$m_{XYZ}$inline$ – измерения магнитометра в ССК XYZ, $inline$S_{m}$inline$ – диагональная матрица перекосов осей, которая включает в себя эффект soft–iron, $inline$M_{XYZ}$inline$ – вектор истинной магнитной индукции в ССК, $inline$b_{m}$inline$ – смещение нулей магнитометра и эффект hard–iron, $inline$n_{m}$inline$ – шум измерений.
<spoiler title="Как выбираются параметры магнитометра из даташита">
<h3>Для MPU-9250:</h3>
<ul>
	<li>Смещение нулей - </li>
        <li>Погрешность масштабных коэффициентов - I</li>
        <li>Перекосы осей  </li>
        <li> </li>
        <li> </li>
</ul>
<h3>Для ADIS16488A:</h3>
<ul>
       <li>r </li>
       <li> </li>
       <li> </li>
       <li> </li>
</ul>
</spoiler>

	<li>Для наглядности все параметры сведены в таблицу:
<table>
  <tr>
    <th>ИИБ (инерциальный измерительный блок)</th>
    <th>MPU9250
Акселерометр</th>
     <th>MPU9250
Магнитометр</th>
<th>ADIS16488A
Акселерометр</th>
<th>ADIS16488A
Магнитометр</th>
  </tr>
  <tr>
    <td>Смещение нулей</td>
    <td>$$display$$\pm 60(X,Y), 
$$display$$ $$display$$\pm 80(Z) mg $$display$$ </td>
    <td>$$display$$1 \ мкТл (после\ калибровки)$$display$$</td>
<td>ячейка 41</td>
<td>Ячейка 51</td>
  </tr>
  <tr> 
    <td>Погрешность масштабного коэффициента</td>
    <td>$$display$$\pm3\% $$display$$</td>
    <td>$$display$$10\%(после калибровки)$$display$$</td>
<td>Ячейка 42</td>
<td>Ячейка 52</td>
  </tr>
<tr> 
    <td>Перекосы осей</td>
    <td>$$display$$\pm2\%$$display$$</td>
    <td>$$display$$ – $$display$$</td>
<td>Ячейка 43</td>
<td>Ячейка 53</td>
  </tr>
<tr> 
    <td>Шум на выходе</td>
    <td>$inline$ 0.3 mg/sqrt(Гц)\rightarrow 
4.4 mg\:СКО (218 Гц)$inline$</td>
    <td>$inline$ 0.6 mg\: мкТл\:СКО $inline$</td>
<td>Ячейка 44</td>
<td>Ячейка 54</td>
  </tr>
</table>

<h2>Расчет углов ориентации</h2>Возьмем самый простой способ расчета углов, приведенный <a href="https://www.nxp.com/docs/en/application-note/AN3461.pdf"> тут.</a> Благодаря наличию на Земле силы тяжести, акселерометры "чувствуют" направление вниз. Их измерения используются для расчета углов крена и тангажа. Третий угол - рыскания (а в данном случае - магнитного азимута), может быть определен благодаря наличию у Земли магнитного поля. Вектор индукции магнитного поля измеряется магнитометрами и их измерения участвуют в расчете угла рыскания.
$$display$$roll=\arctan \left ( \frac{a_{Y}}{a_{Z}} \right ),$$display$$ $$display$$pitch=\arctan\left ( \frac{-a_{X}}{\sqrt{a_{Y}^{2}+a_{Z}^{2}}} \right ),$$display$$ $$display$$yaw=\arctan 2\left ( \frac{m_{E}}{m_{N}} \right ),$$display$$ где $inline$arctan 2$inline$ - функция полного арктангенса, $inline$a_{X}$inline$, $inline$a_{Y}$inline$, $inline$a_{Z}$inline$ - измерения акселерометра по трём осям в ССК, $inline$m_{E}$inline$, $inline$m_{N}$inline$ - измерения магнитометра по осям E, N (измерения магнитометров пересчитаны в плоскость).

<h2>Ошибки оценивания углов ориентации</h2> <h3>Описание алгоритма</h3>
<img src="habrastorage.org/webt/hp/fd/sk/hpfdskenhju5llqjoeffmsbryye.png"/>
	<li>Сформируем массивы случайных углов Эйлера roll, pitch, yaw. Они будут задавать наборы вариантов истинной ориентации объекта в модели.<spoiler title="Зачем много углов?">Потому что ошибки зависят от значения углов ориентации, и если мы хотим получить представление об их величине во всем диапазоне изменения - то это самый простой способ.</spoiler>Далее необходимо сформировать истинный вектор магнитной индукции и вектор силы тяжести.</li>
	<li> Из случайных углов roll, pitch, yaw формируется матрица преобразования из ССК XYZ в ЛСК ENU:
$$display$$C_{ENU}^{XYZ}=\begin{vmatrix}
cy\cdot cp &-cr\cdot sy+sr\cdot cy\cdot sp &sr\cdot sy+cr\cdot cy\cdot sp \\ 
	sy\cdot cp &cr\cdot cy+sr\cdot sy\cdot sp & -sr\cdot cy+cr\cdot sy\cdot sp \\ 
	-sp &sr\cdot cp &cr\cdot cp 
	\end{vmatrix},$$display$$  где $inline$cr=\cos (roll)$inline$, $inline$sr=\sin(roll)$inline$, $inline$cp=\cos(pitch)$inline$, $inline$sp=\sin(pitch)$inline$, $inline$cy=\cos(yaw)$inline$, $inline$sy=\sin(yaw)$inline$.</li>
	<li>Используя данную матрицу можно получить выражения для истинных ускорений и магнитных плотностей в ССК:
	$$display$$A_{XYZ}=\left ( C_{ENU}^{XYZ} \right )^{T}\cdot \begin{vmatrix}
	0\\ 
	0\\
	1\\
	\end{vmatrix},$$display$$
	$inline$\begin{vmatrix}
	0\\ 
	0\\ 
	1\\
	\end{vmatrix}$inline$ - вектор, определяющий направление гравитационного ускорения, выраженный в единицах g, $inline${(C_{ENU}^{XYZ} )}^{T}$inline$- транспонированная матрица преобразования координат из ССК в ЛСК.
	$$display$$M_{XYZ}=\left ( C_{ENU}^{XYZ} \right )^{T}\cdot M_{ENU},$$display$$ $inline$ M_{ENU}$inline$ - сформированный вектор истинных магнитных плотностей. 

Далее эти выражения используются в модели измерения датчиков.</li>
	<li>По измерениям датчиков рассчитываются новые углы по формулам:
	$$display$$roll'=\arctan \left ( \frac{a_{Y}}{a_{Z}} \right ),$$display$$ $$display$$pitch'=\arctan\left ( \frac{-a_{X}}{\sqrt{a_{Y}^{2}+a_{Z}^{2}}} \right ),$$display$$ $$display$$yaw'=\arctan 2\left ( \frac{m_{E}}{m_{N}} \right ).$$display$$ </li>
	<li>Ошибки измерения углов ориентации рассчитываются как разность между истинными углами roll, pitch, yaw и углами, рассчитанными по измерениям датчиков - roll', pitch', yaw'.</li>
</ol>

<h2>Результаты</h2>
Вот что получается для наших двух датчиков, взятых для примера.
(тут картинки ошибок углов roll pitch yaw в зависимости от них же)
<img src="https://habrastorage.org/webt/mg/6o/eb/mg6oebpyq4pvqcwxwrymdvjab_y.jpeg" />

<spoiler title="Почему на границах ошибки больше?">Такая математика (про углы Эйлера - что они разрывны?)</spoiler>

(спойлер - можем поиграться с входными параметрами и понять, чем определяются ошибки)
Это относится к тому, что ниже?  (вставить графики под спойлером?)
<b>Влияние погрешностей акселерометра на ошибки оценивания углов крена и тангажа</b>
<b>Влияние погрешностей магнитометра на ошибки оценивания магнитного азимута</b> 
<b>Влияние погрешностей акселерометра и магнитометра на ошибки оценивания магнитного азимута</b>

<h2>Итог ?</h2> 
<ul>
<li> Разработана модель, позволяющая оценивать погрешности расчёта углов ориентации по измерениям акселерометров и магнитометров с учётом их погрешностей.</li>
<li>  Ошибки оценивания углов ориентации являются функциями зависимостей от одновременно всех углов ориентации. При этом максимальные значения ошибок наблюдаются на границах выбранных диапазонов измерений углов. </li>

</ul>
<spoiler title="Спойлер - Дисклеймер: ">
<ul>
	<li> Не рекламируем и не рекомендуем покупать эти датчики (они уже довольно старые). </li>
	<li> Не учитываем влияние вибрации, влияние нелинейности измерений, нестабильности - это первое приближение к ошибкам.</li>
</ul>
</spoiler>
<h2>Литература</h2>
<ul>
	<li>Перов А. И., Харисов В. Н. ГЛОНАСС. Принципы построения и функционирования М.:Радиотехника, 2010. – 800 с.</li>
	<li><a href="https://www.nxp.com/docs/en/application-note/AN3461.pdf">Tilt Sensing Using a Three-Axis Accelerometer, Rev. 6 - Freescale Semiconductor, Inc.</a></li>
	<li><a href="https://www.invensense.com/wp-content/uploads/2015/02/PS-MPU-9250A-01-v1.1.pdf">MPU-9250 Product Specification Revision 1.1 - InvenSense Inc.</a></li>
<li><a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ADIS16488A.pdf"> ADIS16488A Data Sheet - Analog Devices, Inc.</a></li>
	<li></a>
</ul>
</spoiler>
